# ~/openenclave_ml_poc/helloworld/host/CMakeLists.txt

cmake_minimum_required(VERSION 3.16)

# Define the name for your host application executable
set(HOST_APP_NAME helloworld_host)

# List the source files for the host application.
set(HOST_SOURCES
    host.c
    ${EDL_UNTRUSTED_C} # Generated by root CMakeLists.txt, path is available
)
# The untrusted header (e.g., helloworld_u.h) will be included by host.c from the
# EDL_GENERATED_DIR which was added to include_directories in the root CMakeLists.txt.

# Create the host executable
add_executable(${HOST_APP_NAME} ${HOST_SOURCES})

# Link the host executable against the Open Enclave host library.
target_link_libraries(${HOST_APP_NAME} PRIVATE openenclave::oehost)

# Ensure that EDL generation is completed before attempting to build this host application.
add_dependencies(${HOST_APP_NAME} GenerateEDL)

message(STATUS "Configuring Host Application: ${HOST_APP_NAME}")
message(STATUS "  Host sources: ${HOST_SOURCES}")
message(STATUS "  Host executable: ${HOST_APP_NAME}")

# --- Convenience 'run' Targets (Optional) ---

# Path to where the signed enclave will be built by the enclave's CMakeLists.txt
# ENCLAVE_NAME should be consistent with the one set in enclave/CMakeLists.txt
set(ENCLAVE_BUILD_OUTPUT_DIR "${CMAKE_BINARY_DIR}/enclave") # e.g., build/enclave/
set(SIGNED_ENCLAVE_FULL_PATH "${ENCLAVE_BUILD_OUTPUT_DIR}/helloworld_enclave.signed.so")

# Custom target to run the host with the signed enclave.
add_custom_target(run
    COMMAND ./${HOST_APP_NAME} ${SIGNED_ENCLAVE_FULL_PATH}
    # Depends on the host executable and the custom target that produces the signed enclave.
    # 'helloworld_enclave_signed' is the custom target defined in enclave/CMakeLists.txt.
    DEPENDS ${HOST_APP_NAME} helloworld_enclave_signed
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR} # Runs from build/host/
    COMMENT "Running helloworld sample with signed enclave."
)

# Custom target to run the host in simulation mode with the signed enclave.
add_custom_target(run_simulate
    COMMAND ./${HOST_APP_NAME} ${SIGNED_ENCLAVE_FULL_PATH} --simulate
    DEPENDS ${HOST_APP_NAME} helloworld_enclave_signed
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR} # Runs from build/host/
    COMMENT "Running helloworld sample in SIMULATION mode with signed enclave."
)

message(STATUS "  To run: 'make run' or 'make run_simulate' (after successful build).")
message(STATUS "  Run targets expect signed enclave at: ${SIGNED_ENCLAVE_FULL_PATH}")

